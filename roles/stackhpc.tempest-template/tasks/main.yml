---
# tasks file for tempest-template

- name: fail if tt_output_file unset
  fail:
    msg: you must set tt_output_file
  when: not tt_output_file

- name: fail if config file missing
  fail:
    msg: "the file: {{ item }}, does not exist."
  when: not item | exists
  with_items: "{{ tt_config_files }}"

- name: ensure output directory exists
  file:
    path: "{{ tt_output_file | dirname }}"
    state: directory

- name: merge_configs
  merge_configs:
    sources: "{{ tt_config_files }}"
    dest: "{{ tt_output_file }}"
    mode: "{{ tt_mode }}"

- name: add comment warning that this file was auto generated
  blockinfile:
    path: "{{ tt_output_file }}"
    insertbefore: BOF
    block: |
     # WARNING: This file was generated using shakespeare.
     # See: https://github.com/stackhpc/shakespeare